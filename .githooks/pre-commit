#!/usr/bin/env bash
# Pre-commit hook: block commits that contain personal data patterns.
# Checks only staged (to-be-committed) files.

RED='\033[0;31m'
NC='\033[0m'

# Patterns that should never appear in committed files.
# Add your own patterns here (e.g., phone numbers, addresses, employer names).
PATTERNS=(
    # Example patterns â€” customize these for your situation:
    # "your_phone_number_here"
    # "your_email_here"
    # "your_employer_here"
)

if [ ${#PATTERNS[@]} -eq 0 ]; then
    exit 0
fi

PATTERN=$(IFS='|'; echo "${PATTERNS[*]}")

# Only check text files that are staged for commit
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

MATCHES=$(echo "$STAGED_FILES" | xargs grep -lE "$PATTERN" 2>/dev/null)

if [ -n "$MATCHES" ]; then
    echo -e "${RED}BLOCKED:${NC} Personal data pattern detected in staged files:"
    echo "$MATCHES" | while read -r f; do
        echo "  $f"
        grep -nE "$PATTERN" "$f" | head -3 | sed 's/^/    /'
    done
    echo ""
    echo "Remove the personal data or update .githooks/pre-commit to adjust patterns."
    echo "To bypass (if intentional): git commit --no-verify"
    exit 1
fi

exit 0
